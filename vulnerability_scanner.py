import requests
import re
from urllib.parse import urlparse, urljoin
from bs4 import BeautifulSoup
import ssl
import socket
from typing import Dict, List, Any
from datetime import datetime
import json
import sys
import time
import warnings
import urllib3

# Suppress SSL warnings for scanning
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
warnings.filterwarnings('ignore')

# Check Streamlit app
try:
    import streamlit as st
    import plotly.express as px
    import plotly.graph_objects as go
    import pandas as pd

    STREAMLIT_AVAILABLE = True
except ImportError:
    STREAMLIT_AVAILABLE = False
    print("Streamlit not installed")


class VulnerabilityScanner:
    def __init__(self, target_url: str, timeout: int = 10):
        self.target_url = target_url
        self.timeout = timeout
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'CyberSherlock/1.0 (Security Scanner)'
        })
        self.vulnerabilities = []

    def scan_all(self) -> Dict[str, Any]:
        if not STREAMLIT_AVAILABLE:
            print(f"\n[*] Starting security scan of {self.target_url}")
            print("=" * 50)

        results = {
            'url': self.target_url,
            'timestamp': datetime.now().isoformat(),
            'vulnerabilities': [],
            'score': 100,  # Start with perfect score
            'compliance_summary': {}  # Add compliance summary
        }

        # Run security checks
        if not STREAMLIT_AVAILABLE:
            print("[*] Checking for SQL injection vulnerabilities...")
        results['vulnerabilities'].extend(self.check_sql_injection())

        if not STREAMLIT_AVAILABLE:
            print("[*] Checking for XSS vulnerabilities...")
        results['vulnerabilities'].extend(self.check_xss())

        if not STREAMLIT_AVAILABLE:
            print("[*] Checking security headers...")
        results['vulnerabilities'].extend(self.check_security_headers())

        if not STREAMLIT_AVAILABLE:
            print("[*] Checking SSL/TLS configuration...")
        results['vulnerabilities'].extend(self.check_ssl_tls())

        if not STREAMLIT_AVAILABLE:
            print("[*] Checking for exposed sensitive files...")
        results['vulnerabilities'].extend(self.check_directory_traversal())

        if not STREAMLIT_AVAILABLE:
            print("[*] Checking for CSRF vulnerabilities...")
        results['vulnerabilities'].extend(self.check_csrf())

        # Calculate risk score
        results['score'] = self._calculate_risk_score(results['vulnerabilities'])

        # Compliance summary
        results['compliance_summary'] = self._generate_compliance_summary(results['vulnerabilities'])

        return results

    def check_sql_injection(self) -> List[Dict]:
        vulnerabilities = []
        sql_payloads = ["'", '"', "' OR '1'='1", "1' OR '1' = '1", "' OR 1=1--", "admin'--"]

        for payload in sql_payloads:
            try:
                test_url = f"{self.target_url}?id={payload}"
                response = self.session.get(test_url, timeout=self.timeout, verify=False)

                sql_errors = [
                    "SQL syntax", "mysql_fetch", "Warning: mysql",
                    "PostgreSQL", "valid MySQL result", "mssql_",
                    "SQLite", "sql error", "ORA-", "Microsoft Access"
                ]

                for error in sql_errors:
                    if error.lower() in response.text.lower():
                        vulnerabilities.append({
                            'type': 'SQL Injection',
                            'severity': 'CRITICAL',
                            'location': test_url,
                            'details': f'Potential SQL injection detected with payload: {payload}',
                            'remediation': 'Use parameterized queries and prepared statements.',
                            'owasp': 'A03:2021 - Injection',
                            'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                          'A.12.6.1 - Management of Technical Vulnerabilities',
                                          'A.14.1.2 - Securing Application Services on Public Networks'],
                            'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                     'CC6.6 - System Operations',
                                     'PI1.1 - Processing Integrity']
                        })
                        return vulnerabilities
            except:
                continue

        return vulnerabilities

    def check_xss(self) -> List[Dict]:
        vulnerabilities = []
        xss_payloads = [
            '<script>alert(1)</script>',
            '"><script>alert(1)</script>',
            '<img src=x onerror=alert(1)>',
            'javascript:alert(1)',
            '<svg onload=alert(1)>'
        ]

        for payload in xss_payloads:
            try:
                test_url = f"{self.target_url}?search={payload}"
                response = self.session.get(test_url, timeout=self.timeout, verify=False)

                if payload in response.text:
                    vulnerabilities.append({
                        'type': 'Cross-Site Scripting (XSS)',
                        'severity': 'HIGH',
                        'location': test_url,
                        'details': 'Reflected XSS vulnerability - user input not sanitized',
                        'remediation': 'Encode user input and implement CSP.',
                        'owasp': 'A03:2021 - Injection',
                        'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                      'A.14.2.1 - Secure Development Policy',
                                      'A.12.6.1 - Management of Technical Vulnerabilities'],
                        'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                 'CC7.1 - System Monitoring',
                                 'C1.2 - Confidentiality Commitments']
                    })
                    return vulnerabilities
            except:
                continue

        return vulnerabilities

    def check_security_headers(self) -> List[Dict]:
        vulnerabilities = []

        try:
            response = self.session.get(self.target_url, timeout=self.timeout, verify=False)
            headers = response.headers

            security_headers = {
                'X-Frame-Options': {
                    'severity': 'MEDIUM',
                    'recommendation': 'DENY or SAMEORIGIN',
                    'description': 'Protects against clickjacking attacks',
                    'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                  'A.13.1.3 - Segregation in Networks'],
                    'soc2': ['CC6.6 - System Operations',
                             'CC7.1 - System Monitoring']
                },
                'X-Content-Type-Options': {
                    'severity': 'MEDIUM',
                    'recommendation': 'nosniff',
                    'description': 'Prevents MIME-type sniffing',
                    'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                  'A.13.2.3 - Electronic Messaging'],
                    'soc2': ['CC6.6 - System Operations',
                             'CC6.1 - Logical and Physical Access Controls']
                },
                'Strict-Transport-Security': {
                    'severity': 'HIGH',
                    'recommendation': 'max-age=31536000; includeSubDomains',
                    'description': 'Enforces HTTPS connections',
                    'iso_27001': ['A.13.1.1 - Network Controls',
                                  'A.13.2.1 - Information Transfer Policies',
                                  'A.10.1.1 - Policy on the Use of Cryptographic Controls'],
                    'soc2': ['CC6.1 - Logical and Physical Access Controls',
                             'CC6.7 - Transmission Controls',
                             'C1.1 - Confidentiality Policies']
                },
                'Content-Security-Policy': {
                    'severity': 'HIGH',
                    'recommendation': "default-src 'self'",
                    'description': 'Prevents XSS and data injection attacks',
                    'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                  'A.13.1.3 - Segregation in Networks',
                                  'A.12.6.1 - Management of Technical Vulnerabilities'],
                    'soc2': ['CC6.1 - Logical and Physical Access Controls',
                             'CC7.1 - System Monitoring',
                             'CC6.8 - Prevention of Malicious Software']
                },
                'X-XSS-Protection': {
                    'severity': 'LOW',
                    'recommendation': '1; mode=block',
                    'description': 'Legacy XSS protection for older browsers',
                    'iso_27001': ['A.12.6.1 - Management of Technical Vulnerabilities'],
                    'soc2': ['CC6.8 - Prevention of Malicious Software']
                }
            }

            for header, config in security_headers.items():
                if header not in headers:
                    vulnerabilities.append({
                        'type': 'Missing Security Header',
                        'severity': config['severity'],
                        'location': self.target_url,
                        'details': f'{header} header is missing. {config["description"]}',
                        'remediation': f'Add header: {header}: {config["recommendation"]}',
                        'owasp': 'A05:2021 - Security Misconfiguration',
                        'iso_27001': config.get('iso_27001', []),
                        'soc2': config.get('soc2', [])
                    })

        except Exception as e:
            if not STREAMLIT_AVAILABLE:
                print(f"   [-] Error checking headers: {str(e)}")

        return vulnerabilities

    def check_ssl_tls(self) -> List[Dict]:
        vulnerabilities = []

        if not self.target_url.startswith('https://'):
            vulnerabilities.append({
                'type': 'No HTTPS',
                'severity': 'CRITICAL',
                'location': self.target_url,
                'details': 'Website does not use HTTPS encryption',
                'remediation': 'Implement SSL/TLS certificate and redirect HTTP to HTTPS',
                'owasp': 'A02:2021 - Cryptographic Failures',
                'iso_27001': ['A.10.1.1 - Policy on the Use of Cryptographic Controls',
                              'A.10.1.2 - Key Management',
                              'A.13.2.1 - Information Transfer Policies',
                              'A.13.2.3 - Electronic Messaging'],
                'soc2': ['CC6.1 - Logical and Physical Access Controls',
                         'CC6.7 - Transmission Controls',
                         'C1.1 - Confidentiality Policies',
                         'C1.2 - Confidentiality Commitments']
            })
        else:
            try:
                hostname = urlparse(self.target_url).hostname
                context = ssl.create_default_context()

                with socket.create_connection((hostname, 443), timeout=self.timeout) as sock:
                    with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                        if ssock.version() in ['TLSv1', 'TLSv1.1', 'SSLv2', 'SSLv3']:
                            vulnerabilities.append({
                                'type': 'Weak SSL/TLS Version',
                                'severity': 'HIGH',
                                'location': self.target_url,
                                'details': f'Outdated SSL/TLS version: {ssock.version()}',
                                'remediation': 'Use TLS 1.2 or higher.',
                                'owasp': 'A02:2021 - Cryptographic Failures',
                                'iso_27001': ['A.10.1.1 - Policy on the Use of Cryptographic Controls',
                                              'A.14.1.3 - Protecting Application Services Transactions',
                                              'A.13.2.1 - Information Transfer Policies'],
                                'soc2': ['CC6.7 - Transmission Controls',
                                         'C1.1 - Confidentiality Policies']
                            })
            except Exception as e:
                if "certificate verify failed" in str(e):
                    vulnerabilities.append({
                        'type': 'Invalid SSL Certificate',
                        'severity': 'HIGH',
                        'location': self.target_url,
                        'details': 'SSL certificate validation failed',
                        'remediation': 'Use a valid SSL certificate from trusted CA',
                        'owasp': 'A02:2021 - Cryptographic Failures',
                        'iso_27001': ['A.10.1.1 - Policy on the Use of Cryptographic Controls',
                                      'A.10.1.2 - Key Management',
                                      'A.14.1.3 - Protecting Application Services Transactions'],
                        'soc2': ['CC6.7 - Transmission Controls',
                                 'CC2.1 - Baseline Configuration']
                    })

        return vulnerabilities

    def check_csrf(self) -> List[Dict]:
        vulnerabilities = []

        try:
            response = self.session.get(self.target_url, timeout=self.timeout, verify=False)
            soup = BeautifulSoup(response.text, 'html.parser')

            forms = soup.find_all('form')
            for form in forms:
                csrf_token_found = False
                for input_field in form.find_all('input'):
                    input_name = input_field.get('name', '').lower()
                    if 'csrf' in input_name or 'token' in input_name:
                        csrf_token_found = True
                        break

                if not csrf_token_found and form.get('method', '').upper() == 'POST':
                    vulnerabilities.append({
                        'type': 'Missing CSRF Protection',
                        'severity': 'MEDIUM',
                        'location': self.target_url,
                        'details': 'Form found without CSRF token protection',
                        'remediation': 'Implement CSRF tokens for state-changing operations',
                        'owasp': 'A01:2021 - Broken Access Control',
                        'iso_27001': ['A.14.2.5 - Secure System Engineering Principles',
                                      'A.14.1.2 - Securing Application Services on Public Networks',
                                      'A.9.4.1 - Information Access Restriction'],
                        'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                 'CC6.3 - Role-Based Access Control',
                                 'PI1.1 - Processing Integrity']
                    })
                    break

        except:
            pass

        return vulnerabilities

    def check_directory_traversal(self) -> List[Dict]:
        vulnerabilities = []

        sensitive_paths = [
            '/.git/config', '/.env', '/wp-config.php', '/.htaccess',
            '/web.config', '/robots.txt', '/phpinfo.php', '/.gitignore',
            '/backup.sql', '/admin/', '/wp-admin/', '/.svn/', '/config.json'
        ]

        for path in sensitive_paths:
            try:
                test_url = urljoin(self.target_url, path)
                response = self.session.get(test_url, timeout=5, verify=False, allow_redirects=False)

                if response.status_code == 200:
                    if path == '/.git/config' and '[core]' in response.text:
                        vulnerabilities.append({
                            'type': 'Information Disclosure',
                            'severity': 'HIGH',
                            'location': test_url,
                            'details': f'Git repository exposed at {path}',
                            'remediation': 'Remove .git directory from production servers.',
                            'owasp': 'A05:2021 - Security Misconfiguration',
                            'iso_27001': ['A.12.5.1 - Installation of Software on Operational Systems',
                                          'A.12.1.1 - Documented Operating Procedures',
                                          'A.8.2.3 - Handling of Assets',
                                          'A.9.4.1 - Information Access Restriction'],
                            'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                     'CC8.1 - Change Management',
                                     'C1.2 - Confidentiality Commitments']
                        })
                    elif path == '/.env' and '=' in response.text:
                        vulnerabilities.append({
                            'type': 'Critical Information Disclosure',
                            'severity': 'CRITICAL',
                            'location': test_url,
                            'details': 'Environment configuration file exposed',
                            'remediation': 'Remove .env file from web root.',
                            'owasp': 'A05:2021 - Security Misconfiguration',
                            'iso_27001': ['A.8.2.1 - Classification of Information',
                                          'A.8.2.3 - Handling of Assets',
                                          'A.9.4.1 - Information Access Restriction',
                                          'A.12.1.1 - Documented Operating Procedures'],
                            'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                     'CC6.2 - Prior to Issuing System Credentials',
                                     'C1.1 - Confidentiality Policies',
                                     'C1.2 - Confidentiality Commitments']
                        })
                    elif path in ['/admin/', '/wp-admin/'] and response.status_code == 200:
                        vulnerabilities.append({
                            'type': 'Admin Panel Exposed',
                            'severity': 'MEDIUM',
                            'location': test_url,
                            'details': f'Admin panel accessible at {path}',
                            'remediation': 'Restrict admin panel access by IP.',
                            'owasp': 'A01:2021 - Broken Access Control',
                            'iso_27001': ['A.9.4.1 - Information Access Restriction',
                                          'A.9.4.2 - Secure Log-on Procedures',
                                          'A.9.2.3 - Management of Privileged Access Rights',
                                          'A.13.1.3 - Segregation in Networks'],
                            'soc2': ['CC6.1 - Logical and Physical Access Controls',
                                     'CC6.2 - Prior to Issuing System Credentials',
                                     'CC6.3 - Role-Based Access Control']
                        })

            except:
                continue

        return vulnerabilities

    def _calculate_risk_score(self, vulnerabilities: List[Dict]) -> int:
        if not vulnerabilities:
            return 0  # Perfect score for no vulnerabilities

        # Count vulnerabilities by severity
        critical_count = sum(1 for v in vulnerabilities if v.get('severity') == 'CRITICAL')
        high_count = sum(1 for v in vulnerabilities if v.get('severity') == 'HIGH')
        medium_count = sum(1 for v in vulnerabilities if v.get('severity') == 'MEDIUM')
        low_count = sum(1 for v in vulnerabilities if v.get('severity') == 'LOW')

        # Base risk calculation
        risk_score = 0

        # If ANY critical issue exists, minimum score is 76
        if critical_count > 0:
            risk_score = 76
            # Add up to 24 more points based on number of critical issues
            risk_score += min(critical_count * 8, 24)
        # If high issues but no critical: score between 51-75
        elif high_count > 0:
            risk_score = 51
            # Add points based on number of high issues
            risk_score += min(high_count * 8, 24)
        # If medium issues but no high/critical: score between 26-50
        elif medium_count > 0:
            risk_score = 26
            # Add points based on number of medium issues
            risk_score += min(medium_count * 6, 24)
        # Only low issues: score between 1-25
        elif low_count > 0:
            risk_score = 1
            # Add points based on number of low issues
            risk_score += min(low_count * 4, 24)

        return min(100, risk_score)

    def _generate_compliance_summary(self, vulnerabilities: List[Dict]) -> Dict:
        summary = {
            'iso_27001': {},
            'soc2': {},
            'owasp': {}
        }

        for vuln in vulnerabilities:
            # Process ISO 27001 controls
            for control in vuln.get('iso_27001', []):
                if control not in summary['iso_27001']:
                    summary['iso_27001'][control] = []
                summary['iso_27001'][control].append(vuln['type'])

            # Process SOC 2 criteria
            for criteria in vuln.get('soc2', []):
                if criteria not in summary['soc2']:
                    summary['soc2'][criteria] = []
                summary['soc2'][criteria].append(vuln['type'])

            # Process OWASP categories
            owasp = vuln.get('owasp', '')
            if owasp:
                if owasp not in summary['owasp']:
                    summary['owasp'][owasp] = []
                summary['owasp'][owasp].append(vuln['type'])

        return summary

    def generate_report(self, results: Dict) -> str:
        report = f"""# Security Scan Report - CyberSherlock

## Executive Summary
**Target URL:** {results['url']}  
**Scan Date:** {results['timestamp']}  
**Overall Risk Score:** {results['score']}/100

## Statistics
- **Total Vulnerabilities:** {len(results['vulnerabilities'])}
- **Critical:** {sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'CRITICAL')}
- **High:** {sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'HIGH')}
- **Medium:** {sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'MEDIUM')}
- **Low:** {sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'LOW')}

## Compliance Impact Summary

### ISO 27001 Controls Affected
"""
        for control, issues in results.get('compliance_summary', {}).get('iso_27001', {}).items():
            report += f"- **{control}**: {', '.join(set(issues))}\n"

        report += """
### SOC 2 Trust Services Criteria Affected
"""
        for criteria, issues in results.get('compliance_summary', {}).get('soc2', {}).items():
            report += f"- **{criteria}**: {', '.join(set(issues))}\n"

        report += """
## Detailed Findings
"""
        for i, vuln in enumerate(results['vulnerabilities'], 1):
            report += f"""
### {i}. {vuln['type']}
**Severity:** {vuln.get('severity')}  
**OWASP:** {vuln.get('owasp', 'N/A')}  
**ISO 27001 Controls:** {', '.join(vuln.get('iso_27001', ['N/A']))}  
**SOC 2 Criteria:** {', '.join(vuln.get('soc2', ['N/A']))}  
**Location:** {vuln.get('location')}  
**Details:** {vuln.get('details')}  
**Remediation:** {vuln.get('remediation')}  
---
"""

        report += """
---
*Report generated by CyberSherlock Security Scanner*
"""
        return report


def run_cli_scanner():
    print("""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      CyberSherlock Security Scanner        ‚ïë
‚ïë         Web Application Security Tool      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)

    target_url = input("\nEnter target URL (example, https://example.com): ").strip()

    if not target_url.startswith(('http://', 'https://')):
        target_url = 'https://' + target_url

    try:
        scanner = VulnerabilityScanner(target_url)
        results = scanner.scan_all()

        print("\n" + "=" * 50)
        print("SCAN COMPLETED")
        print("=" * 50)

        print(f"\n[+] Risk Score: {results['score']}/100")
        if results['score'] < 30:
            print("    [LOW RISK - System is relatively secure]")
        elif results['score'] < 70:
            print("    [MODERATE RISK - Security improvements needed]")
        else:
            print("    [HIGH RISK - Critical security issues detected]")

        print(f"[+] Vulnerabilities Found: {len(results['vulnerabilities'])}")

        if results['vulnerabilities']:
            print("\n[!] Vulnerabilities Summary:")
            for vuln in results['vulnerabilities']:
                print(f"    {severity_symbol} [{vuln['severity']}] {vuln['type']}")

        print("\n[*] Saving results...")

        with open('scan_results.json', 'w') as f:
            json.dump(results, f, indent=2)
        print("[+] Results saved to scan_results.json")

        report = scanner.generate_report(results)
        with open('scan_report.md', 'w') as f:
            f.write(report)
        print("[+] Report saved to scan_report.md")

    except KeyboardInterrupt:
        print("\n[!] Scan interrupted by user")
    except Exception as e:
        print(f"\n[!] Error: {str(e)}")


def run_streamlit_dashboard():
    # Page configuration
    st.set_page_config(
        page_title="CyberSherlock Security Scanner",
        page_icon="üîç",
        layout="wide",
        initial_sidebar_state="expanded"
    )

    # CSS
    st.markdown("""
    <style>
        :root {
            --dark: #2c1810;
            --burgundy: #8b0000;
            --gold: #d4af37;
            --cream: #f5e6d3;
            --fog: #9b9b9b;
        }
        .stApp {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1e 100%);
        }
        
        div[data-testid="metric-container"] {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.1) 0%, rgba(44, 24, 16, 0.2) 100%);
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Headers */
        h1, h2, h3 {
            font-family: 'Georgia', serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Sidebar */
        section[data-testid="stSidebar"] {
            background: linear-gradient(180deg, #2c1810 0%, #1a0e08 100%);
            border-right: 2px solid #d4af37;
        }

        /* Buttons */
        .stButton > button {
            background: linear-gradient(135deg, #8b0000 0%, #5c0000 100%);
            border: 1px solid #d4af37;
            font-family: 'Georgia', serif;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .stButton > button:hover {
            background: linear-gradient(135deg, #a00000 0%, #6c0000 100%);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        /* Expander styling */
        .streamlit-expanderHeader {
            background: rgba(139, 0, 0, 0.1);
            border: 1px solid #d4af37;
            border-radius: 5px;
        }

        /* Info boxes */
        .stAlert {
            background: linear-gradient(135deg, rgba(245, 230, 211, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            border-left: 4px solid #d4af37;
        }
    </style>
    """, unsafe_allow_html=True)

    # Top page quote
    st.markdown("""
    <div style='text-align: center; color: #d4af37; font-family: Georgia, serif; font-style: italic; margin-bottom: 20px;'>
        "When you eliminate the impossible, whatever remains must be the vulnerability."
    </div>
    """, unsafe_allow_html=True)

    # Initialize session state
    if 'scan_history' not in st.session_state:
        st.session_state.scan_history = []
    if 'current_scan' not in st.session_state:
        st.session_state.current_scan = None

    # Header
    col1, col2, col3 = st.columns([1, 3, 1])
    with col2:
        st.markdown("""
        <h1 style='text-align: center; color: #d4af37; font-family: Georgia, serif; font-size: 48px; margin-bottom: 0;'>
            üîç CyberSherlock
        </h1>
        <h3 style='text-align: center; color: #9b9b9b; font-family: Georgia, serif; font-style: italic; margin-top: 0;'>
            Digital Detective Agency
        </h3>
        """, unsafe_allow_html=True)

    st.markdown("---")

    # Sidebar
    with st.sidebar:
        st.markdown("""
        <div style='text-align: center; padding: 10px; border: 2px solid #d4af37; border-radius: 10px; margin-bottom: 20px;'>
            <h2 style='color: #d4af37; font-family: Georgia, serif; margin: 0;'>Investigation Panel</h2>
        </div>
        """, unsafe_allow_html=True)

        st.header("Target URL")

        target_url = st.text_input(
            "Insert URL",
            placeholder="https://example.com",
            help="Enter the URL you want to scan for vulnerabilities"
        )

        if st.button("Start Scan", type="primary", use_container_width=True):
            if target_url:
                with st.spinner("Scanning in progress..."):
                    try:
                        if not target_url.startswith(('http://', 'https://')):
                            target_url = 'https://' + target_url

                        # Add verify=False to prevent SSL errors during scanning
                        import urllib3
                        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

                        scanner = VulnerabilityScanner(target_url)
                        results = scanner.scan_all()

                        st.session_state.current_scan = results
                        st.session_state.scan_history.append(results)

                        if results['score'] > 0:
                            st.warning(f"Scan completed - {len(results['vulnerabilities'])} issues found")
                        else:
                            st.success("Scan completed successfully!")

                    except Exception as e:
                        st.error(f"Scan failed: {str(e)}")

        if st.button("Clear History", use_container_width=True):
            st.session_state.scan_history = []
            st.session_state.current_scan = None
            st.rerun()

        st.markdown("---")

        # Scan history
        st.header("Recent Scans")
        if st.session_state.scan_history:
            for idx, scan in enumerate(reversed(st.session_state.scan_history[-5:])):
                risk_label = "LOW RISK" if scan['score'] < 30 else "MODERATE" if scan['score'] < 70 else "HIGH RISK"
                if st.button(f"[{risk_label}] {scan['url'][:30]}... ({scan['score']}/100)", key=f"history_{idx}"):
                    st.session_state.current_scan = scan
                    st.rerun()
        else:
            st.info("No scan history yet")

    # Main content area
    if st.session_state.current_scan:
        results = st.session_state.current_scan

        # Metrics
        st.markdown("## Security Assessment Overview")

        col1, col2, col3, col4 = st.columns(4)

        critical_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'CRITICAL')
        high_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'HIGH')
        medium_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'MEDIUM')
        low_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'LOW')

        with col1:
            risk_level = "CRITICAL" if results['score'] > 75 else "HIGH" if results['score'] > 50 else "MODERATE" if \
                results['score'] > 25 else "LOW" if results['score'] > 0 else "SECURE"
            st.metric(
                label="Risk Score",
                value=f"{results['score']}/100",
                delta=risk_level,
                delta_color="inverse" if results['score'] > 50 else "normal"
            )

        with col2:
            st.metric("Critical Issues", critical_count,
                      help="Immediate threats that can lead to system compromise",
                      delta_color="inverse" if critical_count > 0 else "normal")

        with col3:
            st.metric("High Priority", high_count,
                      help="Serious vulnerabilities requiring urgent attention",
                      delta_color="inverse" if high_count > 0 else "normal")

        with col4:
            st.metric("Total Findings", len(results['vulnerabilities']))

        st.markdown("---")

        # Compliance Dashboard
        st.markdown("## Compliance Impact Dashboard")

        # Tabs for different compliance frameworks
        tab1, tab2, tab3, tab4 = st.tabs(["Overview", "ISO 27001", "SOC 2", "OWASP Top 10"])

        with tab1:
            # Overview metrics
            col1, col2, col3 = st.columns(3)

            with col1:
                iso_controls = len(results.get('compliance_summary', {}).get('iso_27001', {}))
                st.metric("ISO 27001 Controls Affected", iso_controls,
                          help="Number of ISO 27001:2022 controls impacted by vulnerabilities")

            with col2:
                soc2_criteria = len(results.get('compliance_summary', {}).get('soc2', {}))
                st.metric("SOC 2 Criteria Affected", soc2_criteria,
                          help="Number of SOC 2 Trust Services Criteria affected")

            with col3:
                owasp_cats = len(results.get('compliance_summary', {}).get('owasp', {}))
                st.metric("OWASP Categories", owasp_cats,
                          help="Number of OWASP Top 10 categories identified")

            # Compliance summary chart
            if results.get('compliance_summary'):
                import plotly.graph_objects as go

                frameworks = ['ISO 27001', 'SOC 2', 'OWASP']
                counts = [
                    len(results['compliance_summary'].get('iso_27001', {})),
                    len(results['compliance_summary'].get('soc2', {})),
                    len(results['compliance_summary'].get('owasp', {}))
                ]

                fig = go.Figure(data=[
                    go.Bar(x=frameworks, y=counts,
                           marker_color=['#8b0000', '#d4af37', '#2c1810'])
                ])

                fig.update_layout(
                    title="Compliance Framework Impact",
                    xaxis_title="Framework",
                    yaxis_title="Number of Controls/Criteria Affected",
                    height=400
                )

                st.plotly_chart(fig, use_container_width=True)

        with tab2:
            st.markdown("### ISO 27001:2022 Controls Impact")

            iso_summary = results.get('compliance_summary', {}).get('iso_27001', {})
            if iso_summary:
                # Group controls by domain
                control_domains = {}
                for control, issues in iso_summary.items():
                    domain = control.split(' - ')[0].split('.')[0]
                    if domain not in control_domains:
                        control_domains[domain] = []
                    control_domains[domain].append((control, issues))

                for domain, controls in sorted(control_domains.items()):
                    with st.expander(f"Domain {domain} ({len(controls)} controls affected)", expanded=False):
                        for control, issues in controls:
                            st.markdown(f"**{control}**")
                            for issue in set(issues):
                                st.markdown(f"  ‚Ä¢ {issue}")
                            st.markdown("")
            else:
                st.info("No ISO 27001 control impacts detected")

        with tab3:
            st.markdown("### SOC 2 Trust Services Criteria Impact")

            soc2_summary = results.get('compliance_summary', {}).get('soc2', {})
            if soc2_summary:
                # Group by Trust Services category
                categories = {
                    'CC': 'Common Criteria',
                    'A': 'Availability',
                    'C': 'Confidentiality',
                    'PI': 'Processing Integrity',
                    'P': 'Privacy'
                }

                categorized = {}
                for criteria, issues in soc2_summary.items():
                    prefix = criteria.split('.')[0].rstrip('0123456789')
                    category = categories.get(prefix, 'Other')
                    if category not in categorized:
                        categorized[category] = []
                    categorized[category].append((criteria, issues))

                for category, criteria_list in sorted(categorized.items()):
                    with st.expander(f"{category} ({len(criteria_list)} criteria affected)", expanded=False):
                        for criteria, issues in criteria_list:
                            st.markdown(f"**{criteria}**")
                            for issue in set(issues):
                                st.markdown(f"  ‚Ä¢ {issue}")
                            st.markdown("")
            else:
                st.info("No SOC 2 criteria impacts detected")

        with tab4:
            st.markdown("### OWASP Top 10 (2021) Mapping")

            owasp_summary = results.get('compliance_summary', {}).get('owasp', {})
            if owasp_summary:
                for category, issues in sorted(owasp_summary.items()):
                    with st.expander(f"{category} ({len(set(issues))} issues)", expanded=False):
                        for issue in set(issues):
                            st.markdown(f"  ‚Ä¢ {issue}")
            else:
                st.info("No OWASP Top 10 issues detected")

        st.markdown("---")

        # Add Risk Score Legend
        with st.expander("Understanding the Risk Score", expanded=True):
            col1, col2 = st.columns([1, 2])
            with col1:
                st.markdown("""
                ### Risk Score Scale
                - **0**: Perfect Security (No vulnerabilities)
                - **1-25**: Low Risk (Minor issues only)
                - **26-50**: Moderate Risk (Attention needed)
                - **51-75**: High Risk (Urgent fixes required)
                - **76-100**: Critical Risk (Immediate action needed)
                """)
            with col2:
                st.markdown("""
                ### How Scoring Works
                - Any **CRITICAL** vulnerability = Minimum score of 76
                - Any **HIGH** severity issue = Minimum score of 51
                - **MEDIUM** issues only = Score between 26-50
                - **LOW** issues only = Score between 1-25
                - Multiple vulnerabilities increase the score within each range
                """)

        # Visualizations
        col1, col2 = st.columns(2)

        with col1:
            # Risk Gauge
            fig_gauge = go.Figure(go.Indicator(
                mode="gauge+number+delta",
                value=results['score'],
                title={'text': "Risk Level", 'font': {'size': 24}},
                delta={'reference': 50, 'increasing': {'color': "red"}},
                gauge={
                    'axis': {'range': [0, 100], 'tickwidth': 1},
                    'bar': {
                        'color': "darkred" if results['score'] > 75 else "red" if results['score'] > 50 else "orange" if
                        results['score'] > 25 else "yellow" if results['score'] > 0 else "green"},
                    'steps': [
                        {'range': [0, 25], 'color': '#c8e6c9'},
                        {'range': [25, 50], 'color': '#fff9c4'},
                        {'range': [50, 75], 'color': '#ffe0b2'},
                        {'range': [75, 100], 'color': '#ffcdd2'}
                    ],
                    'threshold': {
                        'line': {'color': "red", 'width': 4},
                        'thickness': 0.75,
                        'value': 75  # Critical threshold!!
                    }
                }
            ))
            fig_gauge.update_layout(height=400, font={'family': "Arial"})
            st.plotly_chart(fig_gauge, use_container_width=True)

        with col2:
            # Severity Distribution
            severity_data = {
                'CRITICAL': critical_count,
                'HIGH': high_count,
                'MEDIUM': medium_count,
                'LOW': low_count
            }

            filtered_data = {k: v for k, v in severity_data.items() if v > 0}

            if filtered_data:
                import pandas as pd
                #Dataframe for colors
                df_pie = pd.DataFrame(list(filtered_data.items()), columns=['Severity', 'Count'])

                # Color mapping
                color_map = {
                    'CRITICAL': '#ff0000',
                    'HIGH': '#ff9800',
                    'MEDIUM': '#ffeb3b',
                    'LOW': '#4caf50'
                }

                # Colors based on severity
                df_pie['Color'] = df_pie['Severity'].map(color_map)

                fig_pie = go.Figure(data=[go.Pie(
                    labels=df_pie['Severity'],
                    values=df_pie['Count'],
                    marker=dict(colors=df_pie['Color']),
                    textposition='inside',
                    textinfo='value+percent'
                )])

                fig_pie.update_layout(
                    title="Vulnerability Distribution by Severity",
                    height=400
                )
                st.plotly_chart(fig_pie, use_container_width=True)
            else:
                st.success("No vulnerabilities found - System is secure!")

        # Vulnerability severity legend
        st.markdown("---")
        with st.expander("Understanding Vulnerability Severities", expanded=True):
            col1, col2, col3, col4 = st.columns(4)

            with col1:
                st.markdown("""
                ### üî¥ CRITICAL
                **Immediate Action Required**
                - Can be exploited immediately
                - May lead to full system compromise
                - Data breach risk
                - Examples: SQL Injection, Remote Code Execution
                """)

            with col2:
                st.markdown("""
                ### üü† HIGH
                **Urgent Attention Needed**
                - Significant security risk
                - Can lead to data exposure
                - Authentication bypass possible
                - Examples: XSS, Weak Encryption
                """)

            with col3:
                st.markdown("""
                ### üü° MEDIUM
                **Should Be Fixed Soon**
                - Moderate security concern
                - Limited exploitation potential
                - Defense in depth issue
                - Examples: Missing Security Headers
                """)

            with col4:
                st.markdown("""
                ### üü¢ LOW
                **Best Practice Issues**
                - Minor security improvements
                - Informational findings
                - Legacy compatibility issues
                - Examples: Outdated Libraries
                """)

        st.markdown("---")

        # Findings with compliance mapping
        st.markdown("## Detailed Vulnerability Findings")

        if results['vulnerabilities']:
            # Group by severity
            for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
                vulns_of_severity = [v for v in results['vulnerabilities'] if v.get('severity') == severity]
                if vulns_of_severity:
                    severity_colors = {
                        'CRITICAL': 'üî¥',
                        'HIGH': 'üü†',
                        'MEDIUM': 'üü°',
                        'LOW': 'üü¢'
                    }
                    st.markdown(
                        f"### {severity_colors.get(severity, '')} {severity} Severity Issues ({len(vulns_of_severity)})")

                    for vuln in vulns_of_severity:
                        with st.expander(f"{vuln['type']}"):
                            # Main vulnerability details
                            col1, col2 = st.columns([2, 1])
                            with col1:
                                st.write(f"**Details:** {vuln.get('details', 'N/A')}")
                                st.write(f"**Location:** `{vuln.get('location', 'N/A')}`")
                                st.write(f"**Remediation:** {vuln.get('remediation', 'N/A')}")
                            with col2:
                                st.info(f"**OWASP Category:**\n{vuln.get('owasp', 'N/A')}")

                            # Compliance mapping section
                            st.markdown("---")
                            st.markdown("**Compliance Mapping:**")

                            col1, col2 = st.columns(2)
                            with col1:
                                st.markdown("**ISO 27001 Controls:**")
                                for control in vuln.get('iso_27001', ['None']):
                                    st.markdown(f"‚Ä¢ {control}")

                            with col2:
                                st.markdown("**SOC 2 Criteria:**")
                                for criteria in vuln.get('soc2', ['None']):
                                    st.markdown(f"‚Ä¢ {criteria}")
        else:
            st.success("No vulnerabilities detected - System is secure")

        # Export
        st.markdown("---")
        st.markdown("### Export Report")

        # PDF report
        from io import BytesIO
        import base64

        def generate_pdf_report(results):
            try:
                from reportlab.lib import colors
                from reportlab.lib.pagesizes import letter
                from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak, Image
                from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
                from reportlab.lib.units import inch
                from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT, TA_JUSTIFY
                from reportlab.platypus.tableofcontents import TableOfContents
                from reportlab.pdfgen import canvas

                buffer = BytesIO()

                # Page template with header/footer
                def add_page_number(canvas, doc):
                    canvas.saveState()
                    # Footer
                    canvas.setFont('Helvetica', 9)
                    canvas.setFillColor(colors.grey)
                    page_num = canvas.getPageNumber()
                    text = f"CyberSherlock Security Scanner | Page {page_num}"
                    canvas.drawCentredString(letter[0] / 2.0, 0.5 * inch, text)
                    # Header line
                    canvas.setStrokeColor(colors.HexColor('#1f4e79'))
                    canvas.setLineWidth(2)
                    canvas.line(inch, letter[1] - 0.5 * inch, letter[0] - inch, letter[1] - 0.5 * inch)
                    canvas.restoreState()

                doc = SimpleDocTemplate(
                    buffer,
                    pagesize=letter,
                    rightMargin=inch,
                    leftMargin=inch,
                    topMargin=inch,
                    bottomMargin=inch
                )

                story = []
                styles = getSampleStyleSheet()

                title_style = ParagraphStyle(
                    'CustomTitle',
                    parent=styles['Title'],
                    fontSize=28,
                    textColor=colors.HexColor('#1f4e79'),
                    spaceAfter=30,
                    alignment=TA_CENTER,
                    fontName='Helvetica-Bold'
                )

                subtitle_style = ParagraphStyle(
                    'Subtitle',
                    parent=styles['Normal'],
                    fontSize=14,
                    textColor=colors.HexColor('#666666'),
                    alignment=TA_CENTER,
                    spaceAfter=30
                )

                heading1_style = ParagraphStyle(
                    'CustomHeading1',
                    parent=styles['Heading1'],
                    fontSize=18,
                    textColor=colors.HexColor('#1f4e79'),
                    spaceAfter=12,
                    spaceBefore=20,
                    fontName='Helvetica-Bold'
                )

                heading2_style = ParagraphStyle(
                    'CustomHeading2',
                    parent=styles['Heading2'],
                    fontSize=14,
                    textColor=colors.HexColor('#333333'),
                    spaceAfter=8,
                    spaceBefore=12,
                    fontName='Helvetica-Bold'
                )

                normal_style = ParagraphStyle(
                    'CustomNormal',
                    parent=styles['Normal'],
                    fontSize=11,
                    textColor=colors.black,
                    alignment=TA_JUSTIFY,
                    spaceAfter=6
                )

                # Title Page
                story.append(Spacer(1, 2 * inch))
                story.append(Paragraph("CYBERSHERLOCK", title_style))
                story.append(Paragraph("Web Application Security Assessment Report", subtitle_style))
                story.append(Spacer(1, inch))

                # Executive summary box
                exec_summary_data = [
                    ['EXECUTIVE SUMMARY', ''],
                    ['Target URL:', results['url']],
                    ['Assessment Date:', results['timestamp'].split('T')[0]],
                    ['Time:', results['timestamp'].split('T')[1].split('.')[0]],
                    ['Overall Risk Score:', f"{results['score']}/100"],
                    ['Risk Level:',
                     'CRITICAL' if results['score'] > 75 else 'HIGH' if results['score'] > 50 else 'MODERATE' if
                     results['score'] > 25 else 'LOW' if results['score'] > 0 else 'SECURE']
                ]

                exec_table = Table(exec_summary_data, colWidths=[2.5 * inch, 3.5 * inch])
                exec_table.setStyle(TableStyle([
                    # Header row
                    ('SPAN', (0, 0), (1, 0)),
                    ('BACKGROUND', (0, 0), (1, 0), colors.HexColor('#1f4e79')),
                    ('TEXTCOLOR', (0, 0), (1, 0), colors.whitesmoke),
                    ('FONTNAME', (0, 0), (1, 0), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 0), (1, 0), 14),
                    ('ALIGN', (0, 0), (1, 0), 'CENTER'),
                    ('BOTTOMPADDING', (0, 0), (1, 0), 12),
                    # Data rows
                    ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f8f9fa')),
                    ('FONTNAME', (0, 1), (0, -1), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 1), (-1, -1), 11),
                    ('ALIGN', (0, 1), (0, -1), 'RIGHT'),
                    ('ALIGN', (1, 1), (1, -1), 'LEFT'),
                    ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#dee2e6')),
                    ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f8f9fa')]),
                ]))
                story.append(exec_table)

                story.append(PageBreak())

                # Vulnerability statistics
                story.append(Paragraph("VULNERABILITY STATISTICS", heading1_style))

                # Count vulnerabilities
                critical_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'CRITICAL')
                high_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'HIGH')
                medium_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'MEDIUM')
                low_count = sum(1 for v in results['vulnerabilities'] if v.get('severity') == 'LOW')

                stats_data = [
                    ['Severity Level', 'Count', 'Impact'],
                    ['CRITICAL', str(critical_count), 'Immediate action required - System compromise possible'],
                    ['HIGH', str(high_count), 'Urgent attention needed - Significant security risk'],
                    ['MEDIUM', str(medium_count), 'Should be addressed - Moderate security concern'],
                    ['LOW', str(low_count), 'Best practice - Minor security improvement'],
                    ['TOTAL', str(len(results['vulnerabilities'])), '']
                ]

                stats_table = Table(stats_data, colWidths=[1.5 * inch, 0.8 * inch, 3.7 * inch])

                # Color mapping for severity
                row_colors = {
                    1: colors.HexColor('#ffebee') if critical_count > 0 else colors.white,
                    2: colors.HexColor('#fff3e0') if high_count > 0 else colors.white,
                    3: colors.HexColor('#fff9c4') if medium_count > 0 else colors.white,
                    4: colors.HexColor('#f1f8e9') if low_count > 0 else colors.white,
                }

                table_style = [
                    # Header
                    ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#343a40')),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                    ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                    ('FONTSIZE', (0, 0), (-1, 0), 12),
                    ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
                    # Total row
                    ('BACKGROUND', (0, -1), (-1, -1), colors.HexColor('#e9ecef')),
                    ('FONTNAME', (0, -1), (-1, -1), 'Helvetica-Bold'),
                    ('LINEABOVE', (0, -1), (-1, -1), 2, colors.black),
                    # General
                    ('FONTSIZE', (0, 1), (-1, -1), 10),
                    ('ALIGN', (0, 0), (0, -1), 'LEFT'),
                    ('ALIGN', (1, 0), (1, -1), 'CENTER'),
                    ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
                    ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#dee2e6')),
                ]

                # Add row colors
                for row_num, color in row_colors.items():
                    if color != colors.white:
                        table_style.append(('BACKGROUND', (0, row_num), (-1, row_num), color))

                stats_table.setStyle(TableStyle(table_style))
                story.append(stats_table)
                story.append(Spacer(1, 30))

                # Compliance summary section
                story.append(Paragraph("COMPLIANCE IMPACT SUMMARY", heading1_style))

                # ISO 27001 summary
                if results.get('compliance_summary', {}).get('iso_27001'):
                    story.append(Paragraph("ISO 27001:2022 Controls Affected", heading2_style))
                    iso_data = []
                    for control, issues in results['compliance_summary']['iso_27001'].items():
                        iso_data.append([
                            Paragraph(control, normal_style),
                            Paragraph(', '.join(set(issues)), normal_style)
                        ])

                    if iso_data:
                        iso_table = Table(iso_data, colWidths=[3 * inch, 3 * inch])
                        iso_table.setStyle(TableStyle([
                            ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#dee2e6')),
                            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f8f9fa')),
                            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                            ('FONTSIZE', (0, 0), (-1, -1), 10),
                        ]))
                        story.append(iso_table)
                        story.append(Spacer(1, 20))

                # SOC 2 summary
                if results.get('compliance_summary', {}).get('soc2'):
                    story.append(Paragraph("SOC 2 Trust Services Criteria Affected", heading2_style))
                    soc2_data = []
                    for criteria, issues in results['compliance_summary']['soc2'].items():
                        soc2_data.append([
                            Paragraph(criteria, normal_style),
                            Paragraph(', '.join(set(issues)), normal_style)
                        ])

                    if soc2_data:
                        soc2_table = Table(soc2_data, colWidths=[3 * inch, 3 * inch])
                        soc2_table.setStyle(TableStyle([
                            ('GRID', (0, 0), (-1, -1), 1, colors.HexColor('#dee2e6')),
                            ('BACKGROUND', (0, 0), (-1, -1), colors.HexColor('#f8f9fa')),
                            ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                            ('FONTSIZE', (0, 0), (-1, -1), 10),
                        ]))
                        story.append(soc2_table)
                        story.append(Spacer(1, 20))

                story.append(PageBreak())

                # Findings
                story.append(Paragraph("DETAILED VULNERABILITY FINDINGS", heading1_style))
                story.append(Spacer(1, 12))

                # Group vulnerabilities by severity
                for severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
                    severity_vulns = [v for v in results['vulnerabilities'] if v.get('severity') == severity]
                    if severity_vulns:
                        severity_colors_map = {
                            'CRITICAL': colors.HexColor('#d32f2f'),
                            'HIGH': colors.HexColor('#f57c00'),
                            'MEDIUM': colors.HexColor('#fbc02d'),
                            'LOW': colors.HexColor('#689f38')
                        }

                        # Section header
                        section_style = ParagraphStyle(
                            'SectionHeader',
                            parent=heading2_style,
                            textColor=severity_colors_map[severity]
                        )
                        story.append(Paragraph(f"{severity} SEVERITY ISSUES ({len(severity_vulns)})", section_style))
                        story.append(Spacer(1, 8))

                        for vuln in severity_vulns:
                            # Vulnerability box
                            vuln_table_data = []

                            # Title row
                            vuln_table_data.append([Paragraph(vuln['type'], heading2_style)])

                            # Details row
                            details_text = Paragraph(f"<b>Details:</b> {vuln.get('details', 'N/A')}", normal_style)
                            vuln_table_data.append([details_text])

                            # Location row
                            location_text = Paragraph(f"<b>Location:</b> {vuln.get('location', 'N/A')}", normal_style)
                            vuln_table_data.append([location_text])

                            # OWASP row
                            owasp_text = Paragraph(f"<b>OWASP:</b> {vuln.get('owasp', 'N/A')}", normal_style)
                            vuln_table_data.append([owasp_text])

                            # ISO 27001 row
                            iso_controls = ', '.join(vuln.get('iso_27001', ['N/A']))
                            iso_text = Paragraph(f"<b>ISO 27001:</b> {iso_controls}", normal_style)
                            vuln_table_data.append([iso_text])

                            # SOC 2 row
                            soc2_criteria = ', '.join(vuln.get('soc2', ['N/A']))
                            soc2_text = Paragraph(f"<b>SOC 2:</b> {soc2_criteria}", normal_style)
                            vuln_table_data.append([soc2_text])

                            # Remediation row
                            remediation_text = Paragraph(f"<b>Remediation:</b> {vuln.get('remediation', 'N/A')}",
                                                         normal_style)
                            vuln_table_data.append([remediation_text])

                            vuln_table = Table(vuln_table_data, colWidths=[6 * inch])
                            vuln_table.setStyle(TableStyle([
                                ('BACKGROUND', (0, 0), (-1, 0), severity_colors_map[severity]),
                                ('TEXTCOLOR', (0, 0), (-1, 0), colors.white),
                                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                                ('FONTSIZE', (0, 0), (-1, 0), 12),
                                ('BACKGROUND', (0, 1), (-1, -1), colors.HexColor('#f8f9fa')),
                                ('FONTSIZE', (0, 1), (-1, -1), 10),
                                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                                ('BOX', (0, 0), (-1, -1), 1, colors.HexColor('#dee2e6')),
                                ('VALIGN', (0, 0), (-1, -1), 'TOP'),
                                ('LEFTPADDING', (0, 0), (-1, -1), 8),
                                ('RIGHTPADDING', (0, 0), (-1, -1), 8),
                                ('TOPPADDING', (0, 0), (-1, -1), 5),
                                ('BOTTOMPADDING', (0, 0), (-1, -1), 5),
                            ]))

                            story.append(vuln_table)
                            story.append(Spacer(1, 10))

                # PDF with compliance section
                doc.build(story, onFirstPage=add_page_number, onLaterPages=add_page_number)
                pdf = buffer.getvalue()
                buffer.close()
                return pdf

            except ImportError:
                # Fallback if reportlab is not installed
                st.error("Please install reportlab for PDF generation")
                return None

        # PDF download button
        pdf_data = generate_pdf_report(results)
        st.download_button(
            label="Download PDF Report with Compliance Mapping",
            data=pdf_data,
            file_name=f"CyberSherlock_Report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf",
            mime="application/pdf",
            use_container_width=True
        )

    else:
        # Welcome screen
        st.markdown("""
        <div style='text-align: center; margin-bottom: 30px;'>
            <h1 style='color: #d4af37; font-family: Georgia, serif; font-size: 56px; margin-bottom: 10px;'>
                Welcome to the Digital Detective Agency
        </div>
        """, unsafe_allow_html=True)

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("""
            <div style='background: rgba(139, 0, 0, 0.1); border: 1px solid #d4af37; border-radius: 8px; padding: 15px; min-height: 250px; height: auto;'>
                <h3 style='color: #d4af37; font-family: Georgia, serif;'>Investigation Methods</h3>
                <ul style='color: #f5e6d3; line-height: 1.8;'>
                    <li>SQL Injection detection</li>
                    <li>Cross-Site Scripting analysis</li>
                    <li>Security Headers investigation</li>
                    <li>SSL/TLS Configuration review</li>
                    <li>CSRF Protection examination</li>
                    <li>Sensitive Files discovery</li>
                </ul>
            </div>
            """, unsafe_allow_html=True)

        with col2:
            st.markdown("""
            <div style='background: rgba(212, 175, 55, 0.1); border: 1px solid #d4af37; border-radius: 8px; padding: 15px; min-height: 250px; height: auto;'>
                <h3 style='color: #d4af37; font-family: Georgia, serif;'>Compliance Frameworks</h3>
                <ul style='color: #f5e6d3; line-height: 1.8;'>
                    <li>ISO 27001 mapping</li>
                    <li>SOC 2 compliance framework</li>
                    <li>OWASP Top 10 analysis</li>
                    <li>Risk deduction engine</li>
                    <li>Compliance impact reports</li>
                    <li>Visualization tools</li>
                </ul>
            </div>
            """, unsafe_allow_html=True)

        st.markdown("---")

        # Instructions
        st.markdown("""
        <div style='background: rgba(245, 230, 211, 0.05); border-left: 4px solid #d4af37; padding: 20px; margin-top: 20px;'>
            <h3 style='color: #d4af37; font-family: Georgia, serif;'>Begin Your Investigation</h3>
            <ol style='color: #f5e6d3; font-size: 16px; line-height: 2;'>
                <li>Enter the suspect URL in the Investigation Panel</li>
                <li>Click 'Start Scan' to begin the digital investigation</li>
                <li>Review compliance impacts and export your case report</li>
            </ol>
        </div>
        """, unsafe_allow_html=True)

    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; padding: 20px; background: rgba(44, 24, 16, 0.2); border-top: 2px solid #d4af37;'>
        <p style='color: #d4af37; font-family: Georgia, serif; font-size: 16px; margin: 0;'>
             CyberSherlock | Digital Detective Agency | ISO 27001 & SOC 2 Compliant
        </p>
    </div>
    """, unsafe_allow_html=True)


# Main execution
if __name__ == "__main__":
    # Check command line arguments
    if len(sys.argv) > 1 and sys.argv[1] == "--dashboard":
        # Run Streamlit dashboard
        if STREAMLIT_AVAILABLE:
            run_streamlit_dashboard()
        else:
            print("Error: Streamlit not installed")
            sys.exit(1)
    else:
        # Check if running through Streamlit
        if 'streamlit' in sys.modules:
            run_streamlit_dashboard()
        else:
            # Run CLI scanner
            run_cli_scanner()